<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

    <changeSet id="add-new-column-enable_critical_chain_support" author="jaragunde">
        <comment>Add new column enable_critical_chain_support with default value FALSE to configuration table</comment>
        <addColumn tableName="configuration">
            <column name="enable_critical_chain_support" type="BOOLEAN" />
        </addColumn>
        <addDefaultValue tableName="configuration" columnName="enable_critical_chain_support"
            defaultValueBoolean="FALSE" />
        <addNotNullConstraint tableName="configuration"
	    columnName="enable_critical_chain_support"
            defaultNullValue="FALSE"
            columnDataType="BOOLEAN" />
    </changeSet>

    <changeSet id="use-capacity-instead-of-effort_duration-and-not_over_assignable" author="ogonzalez">
        <comment>Convert from duration + notAssignable (not over assignable) to capacity property</comment>
        <addColumn tableName="calendar_exception_type">
            <column name="allowed_extra_effort" type="INTEGER" defaultValue="NULL"/>
        </addColumn>
        <renameColumn tableName="calendar_exception_type" oldColumnName="duration"
                      newColumnName="standard_effort" columnDataType="INTEGER"/>
        <update tableName="calendar_exception_type">
            <column name="allowed_extra_effort" valueNumeric="0" />
            <where>not_assignable</where>
        </update>
        <dropColumn tableName="calendar_exception_type" columnName="not_assignable"/>
    </changeSet>

    <changeSet id="use-capacity-for-exceptions" author="ogonzalez">
        <comment>Convert from duration to capacity property for calendar exceptions</comment>
        <addColumn tableName="calendar_exception">
            <column name="allowed_extra_effort" type="INTEGER" defaultValue="NULL"/>
        </addColumn>
        <renameColumn tableName="calendar_exception" oldColumnName="duration"
                      newColumnName="standard_effort" columnDataType="INTEGER"/>
        <sql>
        update calendar_exception SET allowed_extra_effort =
            (select allowed_extra_effort from calendar_exception_type
                where calendar_exception_type.id = calendar_exception.calendar_exception_id)
        </sql>
    </changeSet>

    <changeSet id="use-capacity-for-capacity-per-day-for-calendar-data" author="ogonzalez">
        <comment>Convert from duration to capacity in effort per day for CalendarData</comment>
        <renameTable newTableName="capacity_per_day" oldTableName="effort_per_day" />
        <addColumn tableName="capacity_per_day">
            <column name="allowed_extra_effort" type="INTEGER" defaultValue="NULL"/>
        </addColumn>
        <renameColumn tableName="capacity_per_day" oldColumnName="effort"
                      newColumnName="standard_effort" columnDataType="INTEGER"/>
    </changeSet>

    <changeSet id="by_default_weekends_are_not_overassignable" author="ogonzalez">
        <comment>By default weekends are not over assignable</comment>
        <sql>
        update capacity_per_day SET allowed_extra_effort = 0
        where day_id IN (5, 6) AND allowed_extra_effort IS NULL
        </sql>
    </changeSet>

    <changeSet id="replace-column-limited_resource-with-resource_type" author="jaragunde">
        <comment>Replace column limited_resource with resource_type in resource table</comment>
        <addColumn tableName="resource">
            <column name="resource_type" type="VARCHAR(64)"/>
        </addColumn>
        <update tableName="resource">
            <column name="resource_type" value="NON_LIMITING_RESOURCE"/>
            <where>limited_resource = false</where>
        </update>
        <update tableName="resource">
            <column name="resource_type" value="LIMITING_RESOURCE"/>
            <where>limited_resource = true</where>
        </update>
        <addNotNullConstraint tableName="resource" columnName="resource_type" />
        <dropColumn tableName="resource" columnName="limited_resource"/>
    </changeSet>

</databaseChangeLog>
